name: PSAR Market Scanner

on:
  schedule:
    # Run at 9:30 AM and 4:30 PM ET (market open/close)
    - cron: '30 13 * * 1-5'  # 9:30 AM ET
    - cron: '30 20 * * 1-5'  # 4:30 PM ET
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Scan type'
        required: true
        default: 'market'
        type: choice
        options:
          - market
          - mystocks
          - friends
      market_cap:
        description: 'Min market cap in billions'
        required: false
        default: '5'
        type: choice
        options:
          - '1'
          - '5'
          - '10'
          - '25'
          - '50'
      include_adr:
        description: 'Include international ADRs'
        required: false
        default: true
        type: boolean
      eps_growth:
        description: 'Min EPS growth % (empty = no filter)'
        required: false
        default: ''
      rev_growth:
        description: 'Min revenue growth % (empty = no filter)'
        required: false
        default: ''
      extra_email:
        description: 'Additional email recipient'
        required: false
        default: ''
      report_title:
        description: 'Report title (for friends mode)'
        required: false
        default: ''

jobs:
  scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install yfinance pandas ta
    
    - name: Run Scanner
      env:
        GMAIL_EMAIL: ${{ secrets.GMAIL_EMAIL }}
        GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
      run: |
        # Build command based on inputs (or use defaults for scheduled runs)
        CMD="python market_scanner.py"
        
        # Scan type (default: market)
        SCAN_TYPE="${{ github.event.inputs.scan_type || 'market' }}"
        if [ "$SCAN_TYPE" == "mystocks" ]; then
          CMD="$CMD -mystocks"
        elif [ "$SCAN_TYPE" == "friends" ]; then
          CMD="$CMD -friends"
        fi
        
        # Market cap (default: 5B for scheduled, or input value)
        MC="${{ github.event.inputs.market_cap || '5' }}"
        if [ "$SCAN_TYPE" == "market" ]; then
          CMD="$CMD -mc $MC"
        fi
        
        # ADR flag (default: true for scheduled runs)
        ADR="${{ github.event.inputs.include_adr }}"
        if [ "$ADR" != "false" ]; then
          CMD="$CMD -adr"
        fi
        
        # Growth filters (only if provided)
        EPS="${{ github.event.inputs.eps_growth }}"
        REV="${{ github.event.inputs.rev_growth }}"
        if [ -n "$EPS" ]; then
          CMD="$CMD -eps $EPS"
        fi
        if [ -n "$REV" ]; then
          CMD="$CMD -rev $REV"
        fi
        
        # Extra email
        EMAIL="${{ github.event.inputs.extra_email }}"
        if [ -n "$EMAIL" ]; then
          CMD="$CMD -e $EMAIL"
        fi
        
        # Report title (friends mode)
        TITLE="${{ github.event.inputs.report_title }}"
        if [ -n "$TITLE" ]; then
          CMD="$CMD -t \"$TITLE\""
        fi
        
        echo "Running: $CMD"
        eval $CMD
    
    - name: Save exit history
      uses: actions/upload-artifact@v4
      with:
        name: exit-history
        path: exit_history.json
        if-no-files-found: ignore
